<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="leaflet2.css" />
	<link rel="stylesheet" href="L.Control.ZoomBar.css"/>
	<link rel="stylesheet" href="leaflet-search.css" />
	<link rel="stylesheet" href="style.css" />
	<link rel="stylesheet" href="leaflet-panel-layers.css">
	<link rel="stylesheet" href="leaflet-measure.css">
	<link rel="stylesheet" href="Leaflet-BigImage.css">
	<link rel="stylesheet" href="legend.css">
	<link rel="stylesheet" href="leaflet.draw.css"/>
	<link rel="stylesheet" href="icons.css"/>
	<link rel="stylesheet" href="ion.rangeSlider.css"/>
	<link rel="stylesheet" href="ion.rangeSlider.skinNice.css"/>
	<link rel="stylesheet" href="Leaflet.Coordinates-0.1.3.css"/>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
	<link rel="stylesheet" href="https://unpkg.com/botui/build/botui.min.css">
    <link rel="stylesheet" href="https://unpkg.com/botui/build/botui-theme-default.css">
    <script src="https://cdn.jsdelivr.net/npm/vue@2"></script>
	<!-- Load Vue FIRST -->
	<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.min.js"></script>
	
	<!-- THEN load BotUI -->
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui.min.css" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/botui/build/botui-theme-default.css" />
	<script src="https://cdn.jsdelivr.net/npm/botui/build/botui.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
	<script src="https://unpkg.com/togeojson"></script> <!-- for KML/GPX to GeoJSON -->
	
	
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
	  background-color: #fff;
	  color: #000;
	  font-family: Arial, sans-serif;
	  margin: 0;
    }

    .full-screen {
      height: 100%;
      background-color: #a9a9a9; /* You can set your desired background color */
      /* Additional styles go here */
    }

	#adminPanelDiv {
	  background-color: #ffffff;
	  box-shadow: 0 0 10px rgba(0,0,0,0.1);
	  border-radius: 6px;
	}

	.places-container {
	  background: #ffffff;
	  padding: 20px;
	  margin: 0;
	}
	
	#placeTable {
	  border-collapse: collapse;
	  background: #ffffff;
	  font-size: 14px;
	  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
	}
	
	#placeTable thead {
	  background-color: #007bff;
	  color: #ffffff;
	}
	
	#placeTable th, #placeTable td {
	  padding: 10px;
	  border: 1px solid #ddd;
	}
	
	#placeTable tbody tr:hover {
	  background-color: #f1f1f1;
	}

	#placeTable img {
	    width: 40px;
	    height: 40px;
	    object-fit: cover;
	    border-radius: 4px;
	}

    #bot-container { position: fixed; bottom: 0; right: 20px; width: 300px; z-index: 1000; }
    #toggleBot { position: fixed; bottom: 10px; right: 20px; z-index: 1001; padding: 10px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
    
	.modal {
	  position: fixed;
	  top: 0;
	  left: 0;
	  width: 100%;
	  height: 100%;
	  z-index: 9999;
	  display: flex;
	  justify-content: center;
	  align-items: center;
      background-color: rgba(0,0,0,0.4); /* overlay dark background */
      pointer-events: none; /* allow clicks through the backdrop */	  
	}
	
	.modal-content {
	  background-color: #fff;
	  padding: 30px 35px;
	  border-radius: 12px;
	  width: 400px;
	  max-width: 90%;
	  box-shadow: 0 4px 20px rgba(0,0,0,0.3);
	  font-family: 'Segoe UI', sans-serif;
	  pointer-events: auto; /* allow clicking inside modal */
	}
	
	.modal-content h3 {
	  margin-top: 0;
	  margin-bottom: 20px;
	  font-size: 20px;
	  font-weight: bold;
	  text-align: center;
	}
	
	.modal-content label {
	  display: block;
	  margin-bottom: 5px;
	  font-weight: 500;
	}
	
	.modal-content input[type="text"],
	.modal-content textarea {
	  width: 100%;
	  padding: 8px;
	  margin-bottom: 15px;
	  border: 1px solid #ccc;
	  border-radius: 6px;
	  font-size: 14px;
	}
	
	.modal-content textarea {
	  resize: vertical;
	  min-height: 60px;
	}
	
	.modal-buttons {
	  display: flex;
	  justify-content: flex-end;
	  gap: 10px;
	  margin-top: 20px;
	}
	
	.modal-buttons .btn {
	  padding: 8px 16px;
	  border: none;
	  border-radius: 6px;
	  margin-left: 8px;
	  font-weight: 500;
	  cursor: pointer;
	}
	
	.modal-buttons .btn-success {
	  background-color: #28a745;
	  color: #fff;
	}
	
	.modal-buttons .btn-secondary {
	  background-color: #6c757d;
	  color: #fff;
	}
	
	.modal-buttons .btn:hover {
	  opacity: 0.9;
	}


    .head, .map, .footer {
      width: 100%;
    }

    .head {
      height: 5%;
      background-color: #a9a9a9;
      display: flex; /* Use flex display */
    }

    .map {
      height: 92%;
      border-radius: 10px; /* Add rounded corners */
    }

	.footer {
	  height: 3%;
	  background-color: #a9a9a9;
	  display: flex;
	  align-items: center;
	  justify-content: space-between;
	}

	.scale-control {
	}

	.coordinates {
	  width: 230px; /* Adjust width as needed */
	  height: 50%; /* Take full height of the textarea */
	  margin: 0 auto; /* Center the textarea */
	}

	.powered {
	font-size: 14px;
	margin-right:10px;
	}

    .upleft {
      width: 85%; /* Adjust the width as needed */
      height: 100%; /* Take full height of the parent container */
      display: flex;
      align-items: center;
      font-size: 20px; /* Set the font size for the buttons */
      letter-spacing: 8px; /* Adjust the letter spacing as needed */
      font-weight: bold;
      margin-left:5px;
    }

    .upright {
      position: relative;
      width: 15%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      font-size: 13px;
      letter-spacing: 2px;
      font-weight: bold;
      padding-right: 15px;
      cursor: pointer;
    }

    .upright.clicked {
      background-color: #616161; /* Change background color when clicked */
    }

    .dropdown-content {
      width: 100%;
      display: block;
      max-height: 0;
      overflow: hidden;
      position: absolute;
      top: 100%;
      right: 0;
      background-color: #ffffff;
      box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
      transition: max-height 0.3s ease; /* Add a smooth transition effect */
      z-index: 1000;
    }

    .dropdown-content a {
      color: #000000;
      padding: 12px 16px;
      text-decoration: none;
      display: block;
      position: relative;
	  display: flex;
	  align-items: center;
	  text-decoration: none; /* Optional: Remove underline from the link */
    }

    .dropdown-content a img {
      margin-right: 10px; /* Optional: Add some spacing between the image and text */
    }

    .dropdown-content a::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 0;
      width: 100%;
      height: 1px;
      background-color: #454545;
    }

    .dropdown-content a:last-child::after {
      display: none; /* Hide separator after the last element */
    }

    .dropdown-content a:hover {
      background-color: #f1f1f1;
    }

    .upright.clicked .dropdown-content {
      max-height: 200px; /* Adjust the maximum height as needed */
    }

    .slide-in-div {
      position: fixed;
      top: 5%;
      right: -300px; /* Initially hide the div off-screen */
      width: 300px;
      height: auto; /* Adjust height according to content */
      max-height: 80%; /* Optional: Set a maximum height if needed */
      background-color: #ffffff;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
      transition: right 0.3s ease; /* Add a smooth transition effect */
      z-index: 2000;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      padding: 10px;
      background-color: #676767;
    }

    .close-btn {
      cursor: pointer;
      color: #fff; /* White color */
    }

    .map-tools {
      margin-left: 20px; /* Adjust the left margin as needed */
    }

	.map-tools span {
	  font-weight: bold;
	  color: #fff; /* White color */
	}

    .layers-content {
      width: 100%;
    }

    .vertical-menu {
      width: 100%; /* Take up the full width */
    }

    .menu-item {
      padding: 10px;
      color: #000;
      text-decoration: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .menu-item:hover {
      background-color: #eee;
    }

    .submenu {
      display: none;
      padding-left: 10px;
    }

    .submenu-item {
      color: #000;
      text-decoration: none;
      display: flex;
      align-items: center;
      margin-top: 5px;
    }

    .toggle-icon {
      margin-left: auto;
    }

    .slide-in-div #geocoder-container {
       padding: 10px;
    }

    #geocoder {
       width: 100%;
       padding: 8px;
       margin-top: 8px;
       border: 1px solid #ccc;
    }

    .slide-in-div #firstlevel-container {
       padding: 10px;
    }

    #firstlevel {
       width: 100%;
       padding: 8px;
    }

    .slide-in-div #secondlevel-container {
       padding: 10px;
    }

    #secondlevel {
       width: 100%;
       padding: 8px;
    }

	 /* Add a CSS class for the results list */
	  .results-list {
		max-height: 0;
		overflow: hidden;
		transition: max-height 0.3s ease; /* Add a smooth transition effect */
		overflow-y: auto; /* Enable vertical scrollbar when content exceeds max-height */
	  }

	  .results-list h3 {
		margin-bottom: 5px;
		position: relative;
		padding-top: 10px;
		padding-bottom: 10px;
		padding-left: 10px;
		background-color: #676767;
		color: #ffffff;
        display: flex;
        align-items: center;
      }

	  .results-list .separator {
		position: absolute;
		width: 100%;
		height: 2px;
		background-color: #565656; /* Adjust the color as needed */
		top: 100%; /* Position the separator just below the h3 element */
		margin-top: 5px;
	  }

	  .results-list ul {
		list-style-type: none;
		padding: 0;
		max-height: 150px;
		overflow-y: auto; /* Enable vertical scrollbar when content exceeds max-height */
	  }

	  .results-list li {
		margin-bottom: 5px;
      }

	.separatoresult {
	  margin-top: 10px;
	  margin-bottom: 10px;
	  height: 1px; /* Set the height of the separator */
	  background-color: #232323; /* Set the background color of the separator */
	  /* Add any other styling properties as needed */
	}

	.leaflet-control-measure {
	  display: none;
	}

	/* Add this style to hide the draw control initially */
	.leaflet-draw.leaflet-control {
	  display: none;
	}

	/* Media query for mobile screens */
	@media (max-width: 767px) {
	  .upright {
		font-size: 9px; /* Adjust the font size for mobile screens */
		width: 30%; /* Adjust the width as needed */
	  }

	  .upleft {
		  width: 70%; /* Adjust the width as needed */
	  }

	  .dropdown-content a {
	      padding: 6px 9px;
	}

	  .dropdown-content a img {
	      margin-right: 5px; /* Optional: Add some spacing between the image and text */
    }
      .slide-in-div {
          width: 40%; /* Set the width for mobile screens */
          right: -40%; /* Adjust the initial position for mobile screens */
    }

    .slide-in-div #geocoder-container {
       padding-left: 10px;
       padding-right: 10px;
       padding-top: 5px;
       padding-bottom: 8px;
    }

    .slide-in-div #firstlevel-container {
       padding-bottom: 8px;
       padding-top: 0px;
    }

    .slide-in-div #secondlevel-container {
       padding-top: 0px;
    }

    #geocoder {
      border-radius: 0; /* Set border-radius to 0 for a rectangular shape */
    }

    #firstlevel {
      border-radius: 0; /* Set border-radius to 0 for a rectangular shape */
    }

    #secondlevel {
      border-radius: 0; /* Set border-radius to 0 for a rectangular shape */
    }
	.results-list ul {
		max-height: 200px;
	}
	.coordinates {
	  width: 150px; /* Adjust width as needed */
	}
	.powered {
	font-size: 8px;
	margin-right:2px;
	}
	}

    /* Customize ZoomBar */
    .leaflet-control-zoomBar {
      border: 200px solid transparent !important; /* Set border width and make it transparent */
      border-radius: 10px; /* Add rounded corners */
      overflow: hidden;
    }

    .leaflet-bar a {
      border-radius: 10px !important; /* Add rounded corners to buttons */
      background-color: #7d8b8f; /* Change the background color here */
    }
    
	#adminPanelDiv .header {
	  background-color: #555;
	  color: #fff;
	  padding: 10px 15px;
	  font-weight: bold;
	  font-size: 16px;
	}
	
	#adminPanelDiv h3 {
	  font-size: 14px;
	  margin-bottom: 8px;
	  margin-top: 18px;
	  color: #333;
	}
	
	#adminPanelDiv input[type="text"],
	#adminPanelDiv input[type="file"],
	#adminPanelDiv select {
	  width: 100%;
	  padding: 6px;
	  margin-bottom: 8px;
	  border: 1px solid #ccc;
	  border-radius: 3px;
	  font-size: 13px;
	}
	
	#adminPanelDiv button {
	  width: 100%;
	  padding: 8px;
	  background-color: #4CAF50;
	  color: white;
	  border: none;
	  border-radius: 3px;
	  font-size: 14px;
	  cursor: pointer;
	}
	
	#adminPanelDiv button:hover {
	  background-color: #45a049;
	}
	
	#adminPanelDiv .form-block {
	  padding: 10px 0;
	  border-bottom: 1px solid #ddd;
	}
    
  </style>
  
</head>

<body>
  <div class="full-screen">
    <div class="head">
      <div class="upleft">
        <span style="color: #ffffff">Prime </span><span style="color: #000000">Map</span>
      </div>
      <div class="upcenter">
      </div>
      <div class="upright" onclick="toggleUprightBackground()">
        <span style="color: #ffffff">Map & Tools</span><img src="maptool.png" alt="Map & Tools">
                <div class="dropdown-content">
		          <a href="#" onclick="openLayersTool()"><img src="layers.png" alt="Map & Tools"> Layers Tool</a>
						<div class="slide-in-div" id="layersToolDiv">
						  <div class="header">
						    <a href="#" onclick="toggleAdminPanel()" style="color:white; font-weight:bold; margin-left: 20px;">Admin</a>
							<div class="map-tools">
							  <span>Map & Tools</span>
							</div>
							<div class="close-btn" onclick="closeLayersTool()">X</div>
						  </div>
						  <div class="layers-content">
							 <!-- Dynamic content injected here -->
							  <div class="vertical-menu" id="dynamicMenu">
							    <!-- JS will populate categories and groups here -->
							  </div>
						  </div>
						</div>
		          <a href="#" onclick="openExternalTool()"><img src="layers.png" alt="Map & Tools"> External Services</a>
						<div class="slide-in-div" id="externalToolDiv">
						  <div class="header">
							<div class="map-tools">
							  <span>Geoservice Control</span>
							</div>
							<div class="close-btn" onclick="closeExternalTool()">X</div>
						  </div>
						  <div class="layers-content">
							<!-- Content for the Layers Tool div goes here -->
							<div class="vertical-menu">
							  <div class="menu-item" onclick="toggleSubMenu('submenu1')">
								<span>Base Layers</span>
								<span class="toggle-icon">‚ûî</span>
							  </div>
							  <div class="submenu" id="submenu1">
								  <label class="submenu-item"><input type="radio" name="basemap" value="terrain" checked> Terrain</label>							  
								  <label class="submenu-item"><input type="radio" name="basemap" value="osm"> OpenStreetMap</label>
								  <label class="submenu-item"><input type="radio" name="basemap" value="satellite"> Satellite</label>
								  <label class="submenu-item"><input type="radio" name="basemap" value="gray"> Grayscale</label>
							  </div>
							  <div class="menu-item" onclick="toggleSubMenu('submenu2')">
								<span>Service Layers</span>
								<span class="toggle-icon">‚ûî</span>
							  </div>
							  <div class="submenu" id="submenu2">
								  <label class="submenu-item"><input type="checkbox" data-type="wms" id="pm25Checkbox" data-layer="pm25"> WMS ‚Äì PM2.5 (CAMS)</label>
								  <input type="range" id="opacitySliderair" min="0" max="1" step="0.1" value="0.5">			
									<div id=pm25Legend style="
									  display: none;
									  position: absolute;
									  bottom: 30px;
									  right: 10px;
									  background: white;
									  border: 1px solid #aaa;
									  padding: 8px;
									  z-index: 1000;
									  box-shadow: 0 0 6px rgba(0,0,0,0.3);
									">
									  <strong style="font-size: 12px;">PM2.5 Concentration <br>(¬µg/m¬≥)</strong>
										<div style="width: 200px; margin-top: 12px;">
										  <div style="font-size: 12px; font-weight: bold;">PM2.5 Concentration (¬µg/m¬≥)</div>
										  <div style="margin-top: 6px; display: flex; align-items: center;">
										    <div style="flex-grow: 1; height: 20px;
										      background: linear-gradient(to right,
										        #00e400 0%,     /* green: good */
										        #ffff00 25%,    /* yellow: moderate */
										        #ff7e00 50%,    /* orange: unhealthy for sensitive groups */
										        #ff0000 70%,    /* red: unhealthy */
										        #8f3f97 85%,    /* purple: very unhealthy */
										        #7e0023 100%    /* maroon: hazardous */
										      );
										      border: 1px solid #999;">
										    </div>
										  </div>
										  <div style="display: flex; justify-content: space-between; font-size: 10px; margin-top: 4px;">
										    <span>0</span>
										    <span>12</span>
										    <span>35</span>
										    <span>55</span>
										    <span>150</span>
										    <span>250+</span>
										  </div>
										</div>									</div>								  					  
								  <label class="submenu-item"><input type="checkbox" data-type="wms" data-layer="elevation"> WMS ‚Äì Elevation</label>
								  <input type="range" id="opacitySliderelevation" min="0" max="1" step="0.1" value="0.5">								  
								  <label class="submenu-item"><input type="checkbox" data-type="wms" data-layer="precipitation"> WMS ‚Äì Precipitation</label>
								  <input type="range" id="opacitySliderprecipitation" min="0" max="1" step="0.1" value="0.5">
								  <div id="precipLegend" style="
									  display: none;
									  position: absolute;
									  bottom: 30px;
									  right: 10px;
									  background: white;
									  border: 1px solid #aaa;
									  padding: 8px;
									  z-index: 1000;
									  box-shadow: 0 0 6px rgba(0,0,0,0.3);
									">
									  <strong style="font-size: 12px;">Precipitation<br>(mm/hr)</strong>
										<div style="width: 200px;">
										  <div style="font-size: 12px; font-weight: bold;">Precipitation (mm/hr)</div>
										  <div style="margin-top: 6px; display: flex; align-items: center;">
										    <div style="flex-grow: 1; height: 20px;
										      background: linear-gradient(to right,
										        #00008b 0%,    /* dark blue ~0.1 mm/hr */
										        #4169e1 15%,   /* royal blue */
										        #00ff00 30%,   /* green ~5 mm/hr */
										        #ffff00 50%,   /* yellow ~10 mm/hr */
										        #ffa500 65%,   /* orange ~20 mm/hr */
										        #ff0000 80%,   /* red ~40 mm/hr */
										        #ff00ff 90%,   /* magenta ~80 mm/hr */
										        #ffffff 100%   /* white >100 mm/hr */
										      );
										      border: 1px solid #999;">
										    </div>
										  </div>
										  <div style="display: flex; justify-content: space-between; font-size: 10px; margin-top: 4px;">
										    <span>0</span>
										    <span>1</span>
										    <span>5</span>
										    <span>10</span>
										    <span>20</span>
										    <span>40</span>
										    <span>80+</span>
										  </div>
										</div>								
									</div>								  								
							  </div>
							  <div class="menu-item" onclick="toggleSubMenu('submenu4')">
								<span>Add your own data</span>
								<span class="toggle-icon">‚ûî</span>
							  </div>
							  <div class="submenu" id="submenu4">
								  <input type="file" id="customFileInput" accept=".geojson,.json,.kml,.gpx">
							  </div>
							  <!-- Add more menu items and submenus as needed -->
							</div>
						  </div>
						</div>					
		          <a href="#" onclick="opensearchTool()"><img src="search.png" alt="Map & Tools"> Search Tool</a>
						<div class="slide-in-div" id="searchToolDiv">
						  <div class="header">
							<div class="map-tools">
							  <span>Search Tool</span>
							</div>
							<div class="close-btn" onclick="closesearchTool()">X</div>
						  </div>
						  <div class="layers-content">
							<!-- Content for the Layers Tool div goes here -->
								<div id="geocoder-container">
								  <select id="geocoder" onchange="changeMapCenter(this)">
									<option value="">-- Perzgjidhni vendndodhjen --</option>
									<option value="41.32967706646486, 19.81661775374059">Tirane</option>
									<option value="42.067634608672, 19.511931661415602">Shkoder</option>
									<option value="40.616757686402366, 20.78121887765428">Korce</option>
									<option value="41.8781,-87.6298">Vlore</option>
									<option value="41.8781,-87.6298">Fier</option>
									<option value="41.8781,-87.6298">Elbasan</option>
									<!-- Add more locations as needed with coordinates -->
								  </select>
								</div>
								<div id="firstlevel-container">
								  <select id="firstlevel" onchange="populateSecondLevel()">
									<option value="">-- Perzgjidhni Kategorine --</option>
									<option value="Accomodation">Accomodation</option>
									<option value="Food&Drink">Food&Drink</option>
									<option value="Entertainment">Entertainment</option>
									<option value="Outdoor">Outdoor</option>
									<!-- Add more locations as needed with coordinates -->
								  </select>
								</div>
								<div id="secondlevel-container">
								  <select id="secondlevel" onchange="toggleCategory(this.value)">
									<option value="">-- Perzgjidhni Nen Kategorine --</option>
								  </select>
								</div>
							    <!-- Add a new div to display results -->
							    <div id="resultsList" class="results-list">
							    <h3>
							      Rezultatet e Kerkimit
							    </h3>
							    <ul id="resultsUl"></ul>
							  </div>
						  </div>
						</div>
		          <a href="#" id="mapToolsLink"><img src="tool.jpg" alt="Map & Tools"> Map Tools</a>
        </div>
      </div>
    </div>
    <div class="map" id="map">
      <!-- Leaflet map will be inserted here -->
    </div>

	<button id="toggleBot">üí¨ Le te planifikojme</button>
	<div id="bot-container" style="display:none;">
	    <div id="botui-app">
	        <bot-ui></bot-ui>
	    </div>
	</div>

	<div class="slide-in-div" id="adminPanelDiv" style="right:-400px; width:300px; padding: 15px; background: #fff;">
	  <div class="header">
	    <span class="map-tools">Admin Panel</span>
	    <div class="close-btn" onclick="toggleAdminPanel()">X</div>
	  </div>
		<div class="admin-section">
		  <h3>Manage Categories</h3>
			<input type="text" id="newCategory" placeholder="New Category Name" style="width:100%; margin-bottom:10px;" />
			<button onclick="addCategory()" class="btn btn-success" style="width:100%; margin-bottom:15px;">Add</button>
		  <select id="categoryList" onchange="populateCategoryEdit(this.value)">
		    <option value="">Select Category</option>
		  </select>
		  <input type="hidden" id="categoryId">
		  <input type="text" id="editCategory" placeholder="Edit Category Name" />
			<div style="display: flex; gap: 10px; margin-bottom: 15px;">
			  <button onclick="updateCategory()" class="btn btn-warning" style="flex: 1;">Update</button>
			  <button onclick="deleteCategory()" class="btn btn-danger" style="flex: 1;">Delete</button>
			</div>
		</div>	
	  <div style="margin-top: 10px;">
	
		<h3 style="margin-bottom: 8px;">Manage Groups</h3>
		
		<!-- Add New Group -->
		<input type="text" id="newGroupName" placeholder="Group Name" style="width:100%; margin-bottom:10px;">
		<select id="categorySelect" style="width:100%; margin-bottom:10px;">
		  <option value="">Select Category</option>
		</select>
	    <label for="placeIcon" style="font-size: small;">Upload Icon:</label>
	    <input type="file" id="groupIcon" style="width:100%; margin-bottom:15px;">		
		<button onclick="addGroup()" style="width:100%; margin-bottom:15px;" class="btn btn-success">Add Group</button>
		
		<!-- Edit Existing Group -->
		<select id="groupList" onchange="populateGroupEdit(this.value)" style="width:100%; margin-bottom:10px;">
		  <option value="">Select Group</option>
		</select>
		<input type="hidden" id="groupId">
		<input type="text" id="editGroupName" placeholder="Edit Group Name" style="width:100%; margin-bottom:10px;">
		<select id="editGroupCategory" style="width:100%; margin-bottom:10px;">
		  <option value="">Select Category</option>
		</select>
		<div style="display: flex; gap: 10px;">
		  <button onclick="updateGroup()" class="btn btn-warning" style="flex: 1;">Update</button>
		  <button onclick="deleteGroup()" class="btn btn-danger" style="flex: 1;">Delete</button>
		</div>

	
	    <h3 style="margin-bottom: 8px;">Add Place</h3>
	    <input type="text" id="placeName" name="name" placeholder="Place Name" autocomplete="new-password" style="width:100%; margin-bottom:10px;">
	    <textarea id="placeDescription" name="description" placeholder="Enter a description"></textarea>
	    <input type="text" id="placeLatitude" name="latitude" placeholder="Latitude" style="width:100%; margin-bottom:10px;">
	    <input type="text" id="placeLongitude" name="longitude" placeholder="Longitude" style="width:100%; margin-bottom:10px;">
	    <button onclick="enableCoordinatePicker()" style="width:100%; margin-bottom:10px;">üìç Pick on Map</button>
	    <select id="groupSelect" name="group" style="width:100%; margin-bottom:10px;">
	      <option value="">Select Group</option>
	    </select>
	    <label for="placeImage" style="font-size: small;">Upload Image:</label>
	    <input type="file" id="placeImage" name="placeImage" style="width:100%; margin-bottom:10px;">
	    <button onclick="addPlace()" style="width:100%;" class="btn btn-success">Add Place</button>
	  </div>
	</div>

	<div class="places-container" style="overflow-x: auto; overflow-y: auto; max-height: 400px; padding: 10px; margin-top: 20px;">
	    <h3>Manage Places</h3>
	    <table id="placeTable" class="display" style="width:100%">
	        <thead>
	            <tr>
	                <th>Name</th>
	                <th>Description</th>
	                <th>Latitude</th>
	                <th>Longitude</th>
	                <th>Group ID</th>
	                <th>Image</th>
	                <th>Actions</th>
	            </tr>
	        </thead>
	        <tbody></tbody>
	    </table>
	</div>


	
	<div id="editModal" class="modal" style="display: none;">
	  <div class="modal-content">
	    <h3>Edit Place</h3>
	    <form id="editForm">
	      <label for="editName">Name:</label>
	      <input type="text" id="editName" name="editName" required>
	
	      <label for="editDescription">Description:</label>
	      <textarea id="editDescription" name="editDescription" required></textarea>
	
	      <label for="editLatitude">Latitude:</label>
	      <input type="text" id="editLatitude" name="editLatitude" required>
	
	      <label for="editLongitude">Longitude:</label>
	      <input type="text" id="editLongitude" name="editLongitude" required>
	
	      <input type="hidden" id="editId" name="editId">
	
	      <div class="modal-buttons">
	        <button type="button" class="btn btn-success" onclick="saveEdit()">Save</button>
	        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
	      </div>
	    </form>
	  </div>
	</div>

<script src="leaflet.js"></script>
<script src="L.Control.ZoomBar.js"></script>
<script src="leaflet-search.js"></script>
<script src="leaflet-search2.js"></script>
<script src="ndertesa.js"></script>
<script src="rruget.js"></script>
<script src="objekte_nightlife.js"></script>
<script src="objekte_nightlife.geojson.js"></script>
<script src="objekte_park.js"></script>
<script src="objekte_park.geojson.js"></script>
<script src="objekte_other.js"></script>
<script src="objekte_other.geojson.js"></script>
<script src="objekte_other.geojson.js"></script>
<script src="objekte_historic.js"></script>
<script src="objekte_traditional.js"></script>
<script src="apartment.geojson.js"></script>
<script src="apartment.js"></script>
<script src="objekte_traditional.geojson.js"></script>
<script src="objekte_bar.js"></script>
<script src="objekte_bar.geojson.js"></script>
<script src="leaflet-panel-layers.js"></script>
<script src="leaflet-measure.js"></script>
<script src="bundle.js"></script>
<script src="Leaflet-BigImage.js"></script>
<script src="legend.js"></script>
<script src="Leaflet.draw.js"></script>
<script src="Tooltip.js"></script>
<script src="Leaflet.Draw.Event.js"></script>
<script src="Control.Draw.js"></script>
<script src="jquery.min.js"></script>
<script src="ion.rangeSlider.js"></script>
<script src="Leaflet.Coordinates-0.1.3.min.js"></script>

<script>

console.log("‚úÖ Script loaded");

	var map = new L.Map('map', {zoom: 16, zoomControl: false, center: new L.latLng(42.06485003956775, 19.508854095648697) });	//set center from first location

	var osmLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
	    attribution: '&copy; OpenStreetMap contributors & Carto',
	    subdomains: 'abcd',
	    minZoom: 2,
	    maxZoom: 19
	}).addTo(map);

    map.setView([42.06485003956775, 19.508854095648697], 15);
    var zoom_bar = new L.Control.ZoomBar({position: 'bottomright'}).addTo(map);

    const baseLayers = {
    	    terrain: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png'),
    	    osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
    	    satellite: L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    	        attribution: '¬© Esri & sources'
    	      }),
    	    gray: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png')
    	  };

    	  document.querySelectorAll('input[name="basemap"]').forEach(radio => {
    	    radio.addEventListener('change', () => {
    	      for (const key in baseLayers) map.removeLayer(baseLayers[key]);
    	      baseLayers[radio.value].addTo(map);
    	    });
    	  });

    	  const serviceLayers = {};

    	  document.querySelectorAll('input[type="checkbox"][data-type]').forEach(checkbox => {
    	    checkbox.addEventListener("change", async function () {
    	      const type = this.dataset.type;
    	      const layerKey = this.dataset.layer;

    	      if (this.checked) {
    	        // ADD LAYER
				if (type === "wms" && layerKey === "pm25") {
				  const pm25Layer = L.tileLayer.wms("https://eccharts.ecmwf.int/wms/?token=public", {
				    layers: "composition_europe_pm2p5_forecast_surface",
				    format: "image/png",
				    transparent: true,
				    version: "1.3.0",
				    attribution: "CAMS / ECMWF"
				  }).addTo(map);
				
				  serviceLayers[layerKey] = pm25Layer;
				}
    	        
				if (type === "wms" && layerKey === "elevation") {
				  const srtmLayer = L.tileLayer.wms("https://ows.terrestris.de/osm/service", {
				    layers: "SRTM30-Colored-Hillshade",
				    format: "image/png",
				    transparent: true,
				    attribution: "SRTM via terrestris"
				  }).addTo(map);
				  serviceLayers[layerKey] = srtmLayer;
				}

    	        if (type === "wms" && layerKey === "precipitation") {
    	        	const precipitationLayer = L.tileLayer.wms(
    	        			  "https://gibs.earthdata.nasa.gov/wms/epsg4326/best/wms.cgi",
    	        			  {
    	        			    layers: "IMERG_Precipitation_Rate",
    	        			    format: "image/png",
    	        			    transparent: true,
    	        			    version: "1.3.0",
    	        			    attribution: "NASA GIBS / EOSDIS",
    	        			    opacity: 0.6
    	        			  }
    	        			).addTo(map);
    	        			  serviceLayers[layerKey] = precipitationLayer;
    	        			}

    	        if (type === "wms" && layerKey === "cadastral") {
    	          // No direct Leaflet-WCS support; you can simulate with pre-rendered WMS as fallback
					const cadastralLayer = L.tileLayer.wms(
					  "https://geoportal.asig.gov.al/service/zrpp/wms", {
					    layers: 'parcela_kadastrale_qkd_042025',
					    format: 'image/png',
					    transparent: true,
					    version: '1.3.0',
					    attribution: "¬© ASIG Geoportal"
					});
					cadastralLayer.addTo(map);
					map.setView([41.33, 19.82], 16); // Zoom to Tirana area
    	          serviceLayers[layerKey] = cadastralLayer;
    	        }

    	        if (type === "wms" && layerKey === "protected_areas") {
    	          const layer = L.tileLayer.wms("https://sedac.ciesin.columbia.edu/geoserver/wms", {
    	            layers: "gpw-v4:gpw-v4-population-density_2020",
    	            format: "image/png",
    	            transparent: true
    	          }).addTo(map);
    	          serviceLayers[layerKey] = layer;
    	        }

    	      } else {
    	        // REMOVE LAYER
    	        if (serviceLayers[layerKey]) {
    	          map.removeLayer(serviceLayers[layerKey]);
    	          delete serviceLayers[layerKey];
    	        }
    	      }
    	    });
    	  });

    	  document.getElementById("opacitySliderair").addEventListener("input", function () {
    		  const opacity = parseFloat(this.value);
    		  if (serviceLayers["pm25"]) {
    		    serviceLayers["pm25"].setOpacity(opacity);
    		  }
    		});

    	  document.getElementById("opacitySliderelevation").addEventListener("input", function () {
    		  const opacity = parseFloat(this.value);
    		  if (serviceLayers["elevation"]) {
    		    serviceLayers["elevation"].setOpacity(opacity);
    		  }
    		});

    	  document.getElementById("opacitySliderprecipitation").addEventListener("input", function () {
    		  const opacity = parseFloat(this.value);
    		  if (serviceLayers["precipitation"]) {
    		    serviceLayers["precipitation"].setOpacity(opacity);
    		  }
    		});
    	    
    const chatbotLayer = L.layerGroup().addTo(map);
    
    let editMarker;
    map.on('click', function (e) {
        const lat = e.latlng.lat.toFixed(6);
        const lng = e.latlng.lng.toFixed(6);

        const modal = document.getElementById("editModal");
        if (modal && window.getComputedStyle(modal).display !== "none") {
            document.getElementById("editLatitude").value = lat;
            document.getElementById("editLongitude").value = lng;

            if (editMarker) map.removeLayer(editMarker);
            editMarker = L.marker([lat, lng]).addTo(map);
        }
    });
    
    function toggleUprightBackground() {
      var uprightDiv = document.querySelector('.upright');
      uprightDiv.classList.toggle('clicked');
    }

    function openLayersTool() {
      var slideInDiv = document.getElementById('layersToolDiv');
      slideInDiv.style.right = '0';
    }

    function closeLayersTool() {
      var slideInDiv = document.getElementById('layersToolDiv');
      slideInDiv.style.right = '-300px';
    }

    function openExternalTool() {
        var slideInDiv = document.getElementById('externalToolDiv');
        slideInDiv.style.right = '0';
    }

    function closeExternalTool() {
    	var slideInDiv = document.getElementById('externalToolDiv');
    	slideInDiv.style.right = '-300px';
    }
    	
    function opensearchTool() {
      var slideInDiv = document.getElementById('searchToolDiv');
      slideInDiv.style.right = '0';
    }

    function closesearchTool() {
      var slideInDiv = document.getElementById('searchToolDiv');
      slideInDiv.style.right = '-300px';
    }

    function toggleSubMenu(submenuId) {
      var submenu = document.getElementById(submenuId);
      submenu.style.display = (submenu.style.display === 'block') ? 'none' : 'block';
    }

  function changeMapCenter(selectElement) {
    var selectedOption = selectElement.options[selectElement.selectedIndex];
    var coordinates = selectedOption.value.split(',');

    if (coordinates.length === 2) {
      map.setView(coordinates, 16);
    }
  }

function populateSecondLevel() {
  var firstLevelSelect = document.getElementById('firstlevel');
  var secondLevelSelect = document.getElementById('secondlevel');

  // Clear existing options
  secondLevelSelect.innerHTML = '<option value="">-- Perzgjidhni Nen Kategorine --</option>';

  // Get the selected value from the first level
  var selectedValue = firstLevelSelect.value;

  // Populate second level based on the selected value
  switch (selectedValue) {
    case 'Accomodation':
      addOption(secondLevelSelect, 'Hotel');
      addOption(secondLevelSelect, 'Boutique');
      addOption(secondLevelSelect, 'Apartments');
      addOption(secondLevelSelect, 'Bed&Breakfast');
      // Add more options as needed
      break;
    case 'Food&Drink':
      addOption(secondLevelSelect, 'Bar');
      addOption(secondLevelSelect, 'Restaurant');
      // Add more options as needed
      break;
    case 'Entertainment':
      addOption(secondLevelSelect, 'Museum');
      addOption(secondLevelSelect, 'Theater');
      // Add more options as needed
      break;
    case 'Outdoor':
      // Add options for Outdoor
      break;
    default:
      // No selection or unrecognized selection
      break;
  }
}

function addOption(select, value) {
  var option = document.createElement('option');
  option.value = value;
  option.text = value;
  select.add(option);
}

function toggleCategory(category) {
  // Clear existing markers and results
  clearMarkers();
  clearResultsList();

  // Add markers based on the selected category
  switch (category) {
    case 'Hotel':
		  addMarkerAndSeparator('Hotel Alis', 42.06604477055956, 19.50859123918394, 'images/other.png', '$150', 'alis.jpg', 'Rruga Kol√´ Idromeno, Shkod√´r, Albania');
		  addMarkerAndSeparator('Hotel Colosseo', 42.07069168092901, 19.51631924929182, 'images/other.png', '$150', 'colosseo.jpg', 'Rruga Kol√´ Idromeno, Shkod√´r, Albania');
		  addMarkerAndSeparator('Hotel Chicago', 42.067215764334094, 19.5145158394787, 'images/other.png', '$30', 'chicago.jpg', 'Rruga Kol√´ Idromeno, Shkod√´r, Albania');
		  addMarkerAndSeparator('Hotel Rozafa', 42.0674903028311, 19.512798552587405, 'images/other.png', '$120', 'rozafa.jpg', 'Rruga Kol√´ Idromeno, Shkod√´r, Albania');
      // Add more markers as needed
      break;
    case 'Boutique':
        addMarkerAndSeparator('Boutique Alpha',42.071238488563516, 19.512735150292798, 'images/green.png', '150', 'colosseo.jpg', 'Rruga Kol√´ Idromeno, Shkod√´r, Albania');
        addMarkerAndSeparator('Boutique Terra',42.06873805220787, 19.521808524205888, 'images/green.png', '34', 'colosseo.jpg', 'Rruga Kol√´ Idromeno, Shkod√´r, Albania');
        addMarkerAndSeparator('Boutique Tinder',42.06495342064637, 19.517256664383268, 'images/green.png', '67', 'colosseo.jpg', 'Rruga Kol√´ Idromeno, Shkod√´r, Albania');
        addMarkerAndSeparator('Boutique Sofo',42.06641773937936, 19.506574966666182, 'images/green.png', '200', 'colosseo.jpg', 'Rruga Kol√´ Idromeno, Shkod√´r, Albania');
        addMarkerAndSeparator('Boutique Priklam',42.07020228364651, 19.505239754451548, 'images/green.png', '100', 'colosseo.jpg', 'Rruga Kol√´ Idromeno, Shkod√´r, Albania');
        addMarkerAndSeparator('Boutique Asja',42.070450073317716, 19.518227727812093, 'images/green.png', '90', 'colosseo.jpg', 'Rruga Kol√´ Idromeno, Shkod√´r, Albania');

      // Add more markers as needed
      break;
    // Add cases for other categories
  }

  // Show the results list
  showResultsList();
}

function addMarkerAndSeparator(markerName, lat, lng, iconUrl, image, address) {
  // Add the marker to the results list
  var resultsUl = document.getElementById('resultsUl');

  // Create a list item for the result
  var listItem = document.createElement('li');
  listItem.textContent = markerName;

  // Add an event listener to open the marker's popup when the result is clicked
  listItem.addEventListener('click', function () {
    marker.openPopup();
  });

  // Add an event listener to highlight the background on mouseover
  listItem.addEventListener('mouseover', function () {
    listItem.style.backgroundColor = '#f1f1f1'; // Set the highlight color
  });

  // Add an event listener to remove the highlight on mouseout
  listItem.addEventListener('mouseout', function () {
    listItem.style.backgroundColor = ''; // Remove the highlight color
  });

  // Create a corresponding marker and add it to the map
  var customIcon = L.icon({
    iconUrl: iconUrl,
    iconSize: [32, 32], // Adjust icon size as needed
    iconAnchor: [16, 32], // Adjust icon anchor as needed
    popupAnchor: [0, -32] // Adjust popup anchor as needed
  });

  var marker = L.marker([lat, lng], { icon: customIcon }).addTo(map)
    .bindPopup(`<strong>${markerName}</strong><br>Address: ${address}<br><img src="${image}" alt="Hotel Image" width="100" height="100">`);

  // Append the list item to the results list
  resultsUl.appendChild(listItem);

  // Add a separator after the result
  var separator = document.createElement('div');
  separator.className = 'separatoresult';
  resultsUl.appendChild(separator);
}


function clearResultsList() {
  // Clear the results list
  var resultsUl = document.getElementById('resultsUl');
  resultsUl.innerHTML = '';
}

function showResultsList() {
  // Show the results list by setting max-height to a large value
  var resultsListDiv = document.getElementById('resultsList');
  resultsListDiv.style.maxHeight = '500px'; // Set an appropriate height
}

/*
// Define an object to store marker information for each category
const markers = {
  Hotel: [
    { name: 'Hotel Alis', lat: 42.06604477055956, lng: 19.50859123918394, icon: 'images/other.png', price: 150, image: 'alis.jpg', address: 'Rruga Kol√´ Idromeno, Shkod√´r, Albania'},
    { name: 'Hotel Colosseo', lat: 42.07069168092901, lng: 19.51631924929182, icon: 'images/other.png', price: 50, image: 'colosseo.jpg', address: 'Rruga Kol√´ Idromeno, Shkod√´r, Albania' },
    { name: 'Hotel Chicago', lat: 42.067215764334094, lng: 19.5145158394787, icon: 'images/other.png', price: 30, image: 'chicago.jpg', address: 'Rruga Kol√´ Idromeno, Shkod√´r, Albania' },
    { name: 'Hotel Rozafa', lat: 42.0674903028311, lng: 19.512798552587405, icon: 'images/other.png', price: 120, image: 'rozafa.jpg', address: 'Rruga Teuta, Shkod√´r 4000, Albania' }

    // Add more Hotel markers as needed
  ],
  Boutique: [
    { name: 'Boutique Alpha', lat: 42.071238488563516, lng: 19.512735150292798, icon: 'images/green.png', price: 150, image: 'colosseo.jpg', address: 'Rruga Kol√´ Idromeno, Shkod√´r, Albania' },
    { name: 'Boutique Terra', lat: 42.06873805220787, lng: 19.521808524205888, icon: 'images/green.png', price: 34, image: 'colosseo.jpg', address: 'Rruga Kol√´ Idromeno, Shkod√´r, Albania' },
    { name: 'Boutique Tinder', lat: 42.06495342064637, lng: 19.517256664383268, icon: 'images/green.png', price: 67, image: 'colosseo.jpg', address: 'Rruga Kol√´ Idromeno, Shkod√´r, Albania' },
    { name: 'Boutique Sofo', lat: 42.06641773937936, lng: 19.506574966666182, icon: 'images/green.png', price: 200, image: 'colosseo.jpg', address: 'Rruga Kol√´ Idromeno, Shkod√´r, Albania' },
    { name: 'Boutique Priklam', lat: 42.07020228364651, lng: 19.505239754451548, icon: 'images/green.png', price: 100, image: 'colosseo.jpg', address: 'Rruga Kol√´ Idromeno, Shkod√´r, Albania' },
    { name: 'Boutique Asja', lat: 42.070450073317716, lng: 19.518227727812093, icon: 'images/green.png', price: 90, image: 'colosseo.jpg', address: 'Rruga Kol√´ Idromeno, Shkod√´r, Albania' }

    // Add more Boutique markers as needed
  ],
  // Add more categories as needed
};

// Create an object to store marker layers on the map

*/
let  markers = {}; // Replace the old hardcoded object
let  markerLayers = {};

function toggleMarkers(category, checkbox) {
	console.log("Checkbox toggled:", category, "Checked:", checkbox.checked); // üêû Add this
  // Check if the checkbox is checked or unchecked
  if (checkbox.checked) {
    // If checked, show markers on the map
    showMarkers(category);
  } else {
    // If unchecked, hide markers on the map
    hideMarkers(category);
  }
}

function showMarkers(category) {
	  console.log("All markers object:", markers);

	  const categoryMarkers = markers[category];

	  if (!Array.isArray(categoryMarkers) || categoryMarkers.length === 0) {
	    console.warn(`‚ö†Ô∏è No markers found for category: ${category}`);
	    return; // Nothing to do
	  }

	  categoryMarkers.forEach(markerInfo => {
	    const { name, lat, lng, icon, image, address } = markerInfo;

	    if (!markerLayers[name]) {
	      const marker = L.marker([lat, lng], {
	        icon: L.icon({ iconUrl: icon, iconSize: [30, 30], iconAnchor: [15, 30] })
	      }).addTo(map);

	      marker.bindPopup(`
	        <strong>${name}</strong><br>
	        Address: ${address}<br>
	        <img src="${image}" alt="Marker Image" style="max-width: 100px;">
	      `);

	      markerLayers[name] = marker;
	    }
	  });
	}


function hideMarkers(category) {
	  const categoryMarkers = markers[category];

	  if (!Array.isArray(categoryMarkers) || categoryMarkers.length === 0) {
	    console.warn(`‚ö†Ô∏è No markers to hide for category: ${category}`);
	    return;
	  }

	  categoryMarkers.forEach(markerInfo => {
	    const { name } = markerInfo;
	    const markerLayer = markerLayers[name];

	    if (markerLayer) {
	      map.removeLayer(markerLayer);
	      delete markerLayers[name]; // Clean up memory
	    }
	  });
	}

function clearMarkers() {
  map.eachLayer(function (layer) {
    if (layer instanceof L.Marker) {
      map.removeLayer(layer);
    }
  });
}

    // Initialize the measure control
    var measureControl = new L.Control.Measure({
        primaryLengthUnit: 'meters', // You can change the units as needed
        secondaryLengthUnit: 'kilometers',
        primaryAreaUnit: 'sqmeters',
        secondaryAreaUnit: 'hectares',
        position: 'topleft', // Set the position to 'topleft'
    });

    // Add the measure control to the map
    map.addControl(measureControl);

	// Event handler for the "Map Tools" link
	document.querySelector('#mapToolsLink').addEventListener('click', function () {
	  // Toggle the visibility of the measure control
	  var measureControlDiv = document.querySelector('.leaflet-control-measure');
	  if (measureControlDiv.style.display === 'none' || measureControlDiv.style.display === '') {
		measureControlDiv.style.display = 'block';
	  } else {
		measureControlDiv.style.display = 'none';
	  }
	});

	// Create a feature group to store drawn items
	var drawnItems = new L.FeatureGroup().addTo(map);

	// Initialize the draw control hidden
	var drawControl = new L.Control.Draw({
	  edit: {
		featureGroup: drawnItems,
		poly: {
		  allowIntersection: false,
		},
	  },
	  draw: {
		polygon: {
		  allowIntersection: false,
		  showArea: true,
		},
		circle: true,
		rectangle: true,
		marker: true,
		polyline: true,
	  },
	});

	// Add the draw control to the map
	map.addControl(drawControl);

	// Event handler for the "Map Tools" link
	document.querySelector('#mapToolsLink').addEventListener('click', function () {
	  // Toggle the visibility of the measure control
	  var measureControlDiv = document.querySelector('.leaflet-control-measure');
	  if (measureControlDiv.style.display === 'none' || measureControlDiv.style.display === '') {
		measureControlDiv.style.display = 'block';
	  } else {
		measureControlDiv.style.display = 'none';
	  }

	  // Toggle the visibility of the draw control
	  var drawControlDiv = document.querySelector('.leaflet-draw.leaflet-control');
	  if (drawControlDiv.style.display === 'none' || drawControlDiv.style.display === '') {
		drawControlDiv.style.display = 'block';
	  } else {
		drawControlDiv.style.display = 'none';
	  }
	});

	// Add the scale control to the map and set its position to 'bottomleft'
	var scaleControl = L.control.scale({ position: 'bottomleft' }).addTo(map);

	// Set the scale bar content to the scale control's container
	//document.getElementById('scale-bar').appendChild(scaleControl.getContainer());

    // Get the textarea element
	var coordinatesTextarea = document.getElementById('coordinates');

	// Add an event listener to update coordinates when the mouse moves
	map.on('mousemove', function (e) {
	  if (!coordinatesTextarea) return; // <- ‚õëÔ∏è prevent error if it's missing
	
	  if (window.innerWidth > 767) {
	    coordinatesTextarea.value = `Latitude: ${e.latlng.lat.toFixed(4)}, Longitude: ${e.latlng.lng.toFixed(4)}`;
	  } else {
	    coordinatesTextarea.value = `Lat: ${e.latlng.lat.toFixed(4)}, Long: ${e.latlng.lng.toFixed(4)}`;
	  }
	});

	function toggleAdminPanel() {
		  var adminPanel = document.getElementById('adminPanelDiv');
		  adminPanel.style.right = (adminPanel.style.right === '0px') ? '-350px' : '0px';
		}

		function addGroup() {
			  const name = document.getElementById('newGroupName').value;
			  const categoryId = document.getElementById('categorySelect').value;
			  const iconFile = document.getElementById('groupIcon').files[0]; // file input element

			  if (name && categoryId) {
			    const formData = new FormData();
			    formData.append("name", name);
			    formData.append("categoryId", categoryId);
			    if (iconFile) {
			      formData.append("icon", iconFile);
			    }

			    fetch('/api/groups', {
			      method: 'POST',
			      body: formData
			    })
			    .then(response => {
			      if (response.ok) {
			        alert('Group added successfully!');
			        document.getElementById('newGroupName').value = '';
			        document.getElementById('categorySelect').selectedIndex = 0;
			        document.getElementById('groupIcon').value = ''; // reset file
			        loadGroups();
			      } else {
			        response.text().then(msg => alert('Failed: ' + msg));
			      }
			    });
			  } else {
			    alert('Please fill both group name and category.');
			  }
			}

		function loadCategories() {
			  fetch('/api/categories')
			    .then(res => res.json())
			    .then(data => {
			      // 1. Edit category dropdown (for updating category)
			      let categoryList = document.getElementById('categoryList');
			      categoryList.innerHTML = '<option value="">Select Category</option>';

			      // 2. Add group dropdown (select category when creating group)
			      let categorySelect = document.getElementById('categorySelect');
			      categorySelect.innerHTML = '<option value="">Select Category</option>';

			      // 3. Edit group dropdown (select category when editing group)
			      let editGroupCategory = document.getElementById('editGroupCategory');
			      editGroupCategory.innerHTML = '<option value="">Select Category</option>';

			      data.forEach(cat => {
			        categoryList.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
			        categorySelect.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
			        editGroupCategory.innerHTML += `<option value="${cat.id}">${cat.name}</option>`;
			      });
			    });
			}



		function addCategory() {
			  const name = document.getElementById('newCategory').value;
			  if (!name) {
			    alert("Please enter a category name.");
			    return;
			  }

			  fetch('/api/categories', {
			    method: 'POST',
			    headers: {'Content-Type': 'application/json'},
			    body: JSON.stringify({ name })
			  }).then(res => {
			    if (res.ok) {
			      alert('Category added successfully!');
			      document.getElementById('newCategory').value = '';
			      loadCategories(); // üîÑ Refresh dropdowns
			      loadMenuFromDB(); // üîÑ Refresh menu on right
			    } else {
			      res.text().then(msg => alert("Failed: " + msg));
			    }
			  });
			}

			function populateCategoryEdit(id) {
			  const text = document.querySelector(`#categoryList option[value="${id}"]`).innerText;
			  document.getElementById('editCategory').value = text;
			  document.getElementById('categoryId').value = id; // save the id for update/delete
			}

			function updateCategory() {
			    const id = document.getElementById("categoryId").value;
			    const name = document.getElementById("editCategory").value;

			    if (!id || !name) {
			        alert("Please select a category and enter a new name.");
			        return;
			    }

			    fetch(`/api/categories/${id}`, {
			        method: "PUT",
			        headers: {
			            "Content-Type": "application/json"
			        },
			        body: JSON.stringify({ name: name })
			    })
			    .then(response => {
			        if (response.ok) {
			            alert("Category updated!");
			            clearFields();
			            loadCategories();
			        } else {
			            alert("Update failed.");
			        }
			    });
			}


			function deleteCategory() {
			    const id = document.getElementById("categoryId").value;

			    if (!id) {
			        alert("Please select a category to delete.");
			        return;
			    }

			    fetch(`/api/categories/${id}`, {
			        method: "DELETE"
			    })
			    .then(response => {
			        if (response.ok) {
			            alert("Category deleted!");
			            clearFields();
			            loadCategories();
			        } else {
			            alert("Delete failed.");
			        }
			    });
			}


			function clearFields() {
			    document.getElementById("editCategory").value = "";
			    document.getElementById("categoryId").value = "";
			    document.getElementById("categoryList").selectedIndex = 0;
			}

			function loadGroups() {
				  fetch('/api/groups')
				    .then(res => res.json())
				    .then(data => {
				      // First combo (used for editing group)
				      const groupList = document.getElementById('groupList');
				      groupList.innerHTML = '<option value="">Select Group</option>';

				      // Second combo (used for adding a place)
				      const groupSelect = document.getElementById('groupSelect');
				      groupSelect.innerHTML = '<option value="">Select Group</option>';

				      data.forEach(group => {
				        const optionHTML = `<option value="${group.id}" data-name="${group.name}" data-category="${group.categoryId}">${group.name}</option>`;
				        groupList.innerHTML += optionHTML;
				        groupSelect.innerHTML += optionHTML;
				      });
				    })
				    .catch(err => console.error("Error loading groups:", err));
				}


				function populateGroupEdit(id) {
				  const selectedOption = document.querySelector(`#groupList option[value="${id}"]`);
				  document.getElementById('editGroupName').value = selectedOption.dataset.name;
				  document.getElementById('editGroupCategory').value = selectedOption.dataset.category;
				  document.getElementById('groupId').value = id;
				}

				function updateGroup() {
				  const id = document.getElementById("groupId").value;
				  const name = document.getElementById("editGroupName").value;
				  const categoryId = document.getElementById("editGroupCategory").value;

				  if (!id || !name || !categoryId) {
				    alert("Please fill all fields to update.");
				    return;
				  }

				  fetch(`/api/groups/${id}`, {
				    method: "PUT",
				    headers: {
				      "Content-Type": "application/json"
				    },
				    body: JSON.stringify({ name, categoryId: parseInt(categoryId) })
				  })
				  .then(response => {
				    if (response.ok) {
				      alert("Group updated!");
				      clearGroupFields();
				      loadGroups();
				    } else {
				      alert("Update failed.");
				    }
				  });
				}

				function deleteGroup() {
					  const id = document.getElementById("groupId").value;
					  console.log("Deleting group with ID:", id);

					  if (!id || id === "undefined") {
					    alert("‚ùå Select a group to delete.");
					    return;
					  }

					  fetch(`/api/groups/${id}`, {
					    method: "DELETE"
					  })
					  .then(response => {
					    if (response.ok) {
					      alert("‚úÖ Group deleted!");
					      clearGroupFields();
					      loadGroups();
					    } else {
					      response.text().then(text => alert("‚ùå Delete failed:\n" + text));
					    }
					  })
					  .catch(error => {
					    alert("‚ùå Network error:\n" + error.message);
					  });
					}

				function clearGroupFields() {
				  document.getElementById("groupList").selectedIndex = 0;
				  document.getElementById("editGroupName").value = "";
				  document.getElementById("editGroupCategory").selectedIndex = 0;
				  document.getElementById("groupId").value = "";
				}

				document.addEventListener("DOMContentLoaded", () => {
					  console.log("‚úÖ DOM fully loaded");
					  loadCategories();
					  loadGroups();
					  loadMenuFromDB();
					});

					let isPickingCoordinates = false;

					function enableCoordinatePicker() {
					  alert("Click on the map to pick a location.");
					  isPickingCoordinates = true;
					}

					map.on('click', function(e) {
					  if (isPickingCoordinates) {
					    const lat = e.latlng.lat.toFixed(5);
					    const lng = e.latlng.lng.toFixed(5);
					    document.getElementById("placeLatitude").value = lat;
					    document.getElementById("placeLongitude").value = lng;
					    isPickingCoordinates = false;

					    
					  }
					});

					function addPlace() {
					    const name = document.querySelector('[name="name"]').value.trim();
					    const description = document.querySelector('[name="description"]').value.trim();
					    const latitude = document.querySelector('[name="latitude"]').value.trim();
					    const longitude = document.querySelector('[name="longitude"]').value.trim();
					    const groupId = document.querySelector('[name="group"]').value;
					    const imageFile = document.querySelector('[name="placeImage"]').files[0];

					    if (!name || !latitude || !longitude || !groupId) {
					        alert("Please fill in all required fields: Name, Latitude, Longitude, and Group.");
					        return;
					    }

					    const formData = new FormData();
					    formData.append("name", name);
					    formData.append("description", description);
					    formData.append("latitude", latitude);
					    formData.append("longitude", longitude);
					    formData.append("groupId", groupId);
					    if (imageFile) {
					        formData.append("image", imageFile);
					    }

					    fetch("/api/places", {
					        method: "POST",
					        body: formData
					    })
					    .then(res => res.text())
					    .then(data => {
					        alert(data.message || "Place added!");

					        const lat = parseFloat(latitude);
					        const lng = parseFloat(longitude);
					        const iconUrl = data.iconPath || null;

					        let markerOptions = {};
					        if (iconUrl) {
					            markerOptions.icon = L.icon({
					                iconUrl: iconUrl,
					                iconSize: [32, 32],
					                iconAnchor: [16, 32],
					                popupAnchor: [0, -32]
					            });
					        }

					        const marker = L.marker([lat, lng], markerOptions).addTo(map);
					        marker.bindPopup(`<b>${name}</b><br>${description || ''}`);

					        clearFormFields();
					    })
					    .catch(err => alert("Error: " + err));
					}

					function clearFormFields() {
					    document.querySelector('[name="name"]').value = '';
					    document.querySelector('[name="description"]').value = '';
					    document.querySelector('[name="latitude"]').value = '';
					    document.querySelector('[name="longitude"]').value = '';
					    document.querySelector('[name="group"]').selectedIndex = 0;
					    document.querySelector('[name="placeImage"]').value = '';
					}


					async function loadMenuFromDB() {
						console.log("‚úÖ loadMenuFromDB() called");
					    const categoriesRes = await fetch('/api/categories');
					    const groupsRes = await fetch('/api/groups');
					    const placesRes = await fetch('/api/places');
					    const categories = await categoriesRes.json();
					    const groups = await groupsRes.json();
					    const places = await placesRes.json();

					    const menuDiv = document.getElementById('dynamicMenu');
					    menuDiv.innerHTML = ''; // Clear any previous content

					    // Build the category/group menu
					    categories.forEach(category => {
					        const submenuId = `submenu_${category.id}`;

					        // Main menu item
					        const menuItem = document.createElement('div');
					        menuItem.classList.add('menu-item');
					        menuItem.innerHTML = `<span>${category.name}</span><span class="toggle-icon">‚ûî</span>`;
					        menuItem.onclick = () => toggleSubMenu(submenuId);

					        // Submenu container
					        const submenuDiv = document.createElement('div');
					        submenuDiv.classList.add('submenu');
					        submenuDiv.id = submenuId;

					        // Add checkbox for each group
							groups
							  .filter(group => group.categoryId === category.id)
							  .forEach(group => {
							      const label = document.createElement('label');
							      label.classList.add('submenu-item');
							
							      const checkbox = document.createElement('input');
							      checkbox.type = 'checkbox';
							      checkbox.addEventListener('change', function () {
							          toggleMarkers(group.name, this);
							      });
							
							      label.appendChild(checkbox);
							      label.appendChild(document.createTextNode(group.name));
							      submenuDiv.appendChild(label);
							  });

					        menuDiv.appendChild(menuItem);
					        menuDiv.appendChild(submenuDiv);
					    });

					 // ‚úÖ Build group lookup (name + iconPath)
					    const groupMap = {};
					    groups.forEach(group => {
					        groupMap[group.id] = {
					            name: group.name,
					            iconPath: group.iconPath
					        };
					    });

					    markers = {}; // Reset global marker container
					    places.forEach(place => {
					        const group = groupMap[place.groupId];
					        if (!markers[group.name]) markers[group.name] = [];

					        markers[group.name].push({
					            name: place.name,
					            lat: place.latitude,
					            lng: place.longitude,
					            icon: group.iconPath,        // ‚úÖ icon from groups table
					            image: place.iconPath,       // ‚úÖ image from places table
					            address: place.description
					        });
					    });

					}


					// Utility to toggle submenu
					function toggleSubMenu(id) {
					    const submenu = document.getElementById(id);
					    submenu.style.display = submenu.style.display === 'block' ? 'none' : 'block';
					}


					  document.addEventListener("DOMContentLoaded", function () {
						    const precipCheckbox = document.querySelector('input[data-layer="precipitation"]');
						    const precipLegend = document.getElementById("precipLegend");

						    if (precipCheckbox && precipLegend) {
						      precipCheckbox.addEventListener("change", function () {
						        precipLegend.style.display = this.checked ? "block" : "none";
						      });

						      // Optional: initialize visibility based on checkbox state
						      precipLegend.style.display = precipCheckbox.checked ? "block" : "none";
						    }
						  });
					  document.addEventListener("DOMContentLoaded", function () {
						  const pm25Checkbox = document.getElementById("pm25Checkbox");
						  const pm25Legend = document.getElementById("pm25Legend");

						  if (pm25Checkbox && pm25Legend) {
						    pm25Checkbox.addEventListener("change", function () {
						      pm25Legend.style.display = this.checked ? "block" : "none";
						    });

						    // Set initial state on load
						    pm25Legend.style.display = pm25Checkbox.checked ? "block" : "none";
						  }
						});		

					  let customLayer;

					  document.getElementById("customFileInput").addEventListener("change", function (e) {
					    const file = e.target.files[0];
					    if (!file) return;

					    const reader = new FileReader();

					    reader.onload = function (event) {
					      const content = event.target.result;

					      if (file.name.endsWith(".geojson") || file.name.endsWith(".json")) {
					        const geojson = JSON.parse(content);
					        if (customLayer) map.removeLayer(customLayer);
					        customLayer = L.geoJSON(geojson).addTo(map);
					        map.fitBounds(customLayer.getBounds());
					      } else if (file.name.endsWith(".kml") || file.name.endsWith(".gpx")) {
					        const parser = new DOMParser();
					        const xml = parser.parseFromString(content, "text/xml");
					        const geojson = toGeoJSON.kml(xml); // or toGeoJSON.gpx(xml)
					        if (customLayer) map.removeLayer(customLayer);
					        customLayer = L.geoJSON(geojson).addTo(map);
					        map.fitBounds(customLayer.getBounds());
					      } else {
					        alert("Unsupported file type");
					      }
					    };

					    reader.readAsText(file);
					  });
</script>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css">
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>

<script>
function loadPlaces() {
    fetch('/api/places')
        .then(res => res.json())
        .then(data => {
            const table = $('#placeTable').DataTable();
            table.clear();
            data.forEach(place => {
                table.row.add([
                    place.name,
                    place.description,
                    place.latitude,
                    place.longitude,
                    place.groupId,
                    place.iconPath ? `<img src="${place.iconPath}" width="50">` : '',
                    `<button onclick="editPlace(${place.id})">Edit</button>
                     <button onclick="deletePlace(${place.id})">Delete</button>`
                ]);
            });
            table.draw();
        });
}

function editPlace(id) {
    fetch(`/api/places`)
        .then(res => res.json())
        .then(data => {
            const place = data.find(p => p.id === id);
            if (!place) return;
            document.getElementById('editId').value = place.id;
            document.getElementById('editName').value = place.name;
            document.getElementById('editDescription').value = place.description;
            document.getElementById('editLatitude').value = place.latitude;
            document.getElementById('editLongitude').value = place.longitude;
            document.getElementById('editModal').style.display = 'block';
        });
}

function saveEdit() {
    const id = document.getElementById('editId').value;
    const payload = {
        name: document.getElementById('editName').value,
        description: document.getElementById('editDescription').value,
        latitude: parseFloat(document.getElementById('editLatitude').value),
        longitude: parseFloat(document.getElementById('editLongitude').value),
    };
    fetch(`/api/places/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    }).then(() => {
        closeModal();
        loadPlaces();
    });
}

function deletePlace(id) {
    if (confirm("Are you sure you want to delete this place?")) {
        fetch(`/api/places/${id}`, { method: 'DELETE' })
            .then(() => loadPlaces());
    }
}

function closeModal() {
    document.getElementById('editModal').style.display = 'none';
}

$(document).ready(function () {
    $('#placeTable').DataTable();
    loadPlaces();
});


</script>

<script>

	function addMarkers(locations) {
	    chatbotLayer.clearLayers();  // ‚úÖ Clear only chatbot's markers and lines
	
	    const latlngs = [];
	
	    locations.forEach((loc, idx) => {
	        const marker = L.marker([loc.lat, loc.lng]);
	        marker.bindPopup(`${idx + 1}. ${loc.name}`);
	        chatbotLayer.addLayer(marker);  // ‚úÖ Add to chatbot layer group
	        latlngs.push([loc.lat, loc.lng]);
	    });
	
	    const routeLine = L.polyline(latlngs, { color: 'blue' });
	    chatbotLayer.addLayer(routeLine);  // ‚úÖ Add route polyline to chatbot layer
	
	    map.fitBounds(latlngs);
	}


	let botui = new BotUI('botui-app');
	let steps = [];

	function startChatFlow() {
	    steps = []; // Reset steps

	    botui.message.add({
	        content: 'P√´rsh√´ndetje! Mund t√´ t√´ ndihmoj t√´ nd√´rtosh nj√´ itinerar udh√´timi. Ku d√´shiron t√´ shkosh m√´ par√´?'
	    }).then(() => {
	        return botui.action.text({ action: { placeholder: 'p.sh., nj√´ muze apo lokal' } });
	    }).then(res1 => {
	        steps.push(res1.value);

	        return botui.message.add({ content: 'Zgjedhje e mir√´! Dhe √ßfar√´ do t√´ d√´shironit t√´ b√´nit m√´ pas?' });
	    }).then(() => {
	        return botui.action.text({ action: { placeholder: 'p.sh., restorant' } });
	    }).then(res2 => {
	        steps.push(res2.value);

	        return botui.message.add({ content: 'Nj√´ ndales√´ m√´ shum√´?' });
	    }).then(() => {
	        return botui.action.text({ action: { placeholder: 'p.sh., park p√´r relaksim' } });
	    }).then(res3 => {
	        steps.push(res3.value);

	        return botui.message.add({ content: 'Super! Po d√´rgoj t√´ dh√´nat p√´r nd√´rtimin e itinerarit.' });
	    }).then(() => {
	        return fetch('/api/buildRoute', {
	            method: 'POST',
	            headers: { 'Content-Type': 'application/json' },
	            body: JSON.stringify([...steps])
	        });
	    }).then(res => {
	        if (!res.ok) throw new Error("Server error: " + res.status);
	        return res.json();
	    }).then(route => {
	        console.log('üì¶ Route received from server:', route);

	        if (!Array.isArray(route)) {
	            botui.message.add({ content: '‚ùå Formati i p√´rgjigjes ishte i gabuar!' });
	            return;
	        }

	        if (route.length === 0) {
	            botui.message.add({ content: '‚ö†Ô∏è Nuk u gjet asnj√´ vend p√´r k√´t√´ itinerar.' });
	            return;
	        }

	        const names = route.map(p => p.name).join(' ‚ûù ');
	        botui.message.add({ content: '‚úÖ Itinerari u krijua me sukses! üìç ' + names });

	        drawRoute(route);
	    }).catch(err => {
	        console.error(err);
	        botui.message.add({ content: '‚ùå Ndodhi nj√´ gabim gjat√´ krijimit t√´ itinerarit.' });
	    });
	}

	let routeLayer;
	function drawRoute(route) {
	    if (routeLayer) {
	        map.removeLayer(routeLayer);
	    }

	    const latlngs = route.map(p => [p.latitude, p.longitude]);

	    routeLayer = L.polyline(latlngs, { color: 'blue' }).addTo(map);
	    map.fitBounds(routeLayer.getBounds());

	    latlngs.forEach(function(latlng, i) {
	        L.marker(latlng).bindPopup((i + 1) + '. ' + route[i].name).addTo(map);
	    });
	}
	
    document.getElementById('toggleBot').addEventListener('click', () => {
        const botContainer = document.getElementById('bot-container');
        const wasHidden = botContainer.style.display === 'none';

        botContainer.style.display = wasHidden ? 'block' : 'none';

        if (wasHidden) {
            steps.length = 0;
            botui.message.add({ content: 'P√´rsh√´ndetje p√´rs√´ri! Le t√´ planifikojm√´ itinerarin t√´nd.' }).then(startChatFlow);
        }
    });
</script>
</body>
</html>
